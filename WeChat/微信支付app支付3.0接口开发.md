# 微信支付app支付3.0接口开发

最近在做微信支付，因为前段时间做了微信的公众账号支付，我以为是一个东西，结果发现不是，我真是醉了，竟然是独立的两套东西。

![](http://ww4.sinaimg.cn/large/692869a3gw1exdqakso33j20ny0dptbi.jpg)

整个微信支付，分为三大平台：

- ｀公众平台｀(就是公众账号那个)
- ｀开发平台｀(主要针对app这块)
- ｀商户平台｀(所有微信支付的结算,最终在这里)。

三个平台的账号都不同，而且必须不同，不然不让你注册。其中，需要用户注册的是公众平台和开放平台，当你审核通过以后，
就会给你分配一个对应的商户号。也就是说，你一个公司，申请一个公众号和一个开放平台账号，分别给你一个商户号，你就一共有两个商户号。
这两个商户号不同，我之前就是拿着公众账号对应的商户号(客户给错了)，去做app支付，一直说不对应。

下面进入正文，看看怎么开发。

### 准备工作

首先你需要注册[开放平台](https://open.weixin.qq.com/)账号，然后添加一个app应用(里面包含你的appid和appkey)，并且进行认证，
然后就会收到一封邮件，里面包含了你分到的商户号。

### 流程图

接下来，我们需要搞清楚微信app支付开发的流程，如下图所示。

![](http://ww1.sinaimg.cn/large/692869a3gw1exgxrb07bfj20ou0sy453.jpg)

其中，红色的部分是需要我们做的，具体分下来，客户端要做的事就比较少，生成预支付订单，返回签名的package这些都是服务端做的
(开发客户端真爽)，当然从另外一个角度来说，这些事情也确实应该放在服务器端来做，因为涉及到一些key和密钥之类的东西，
放在客户端app中不安全，如果app被反编译就暴露了这些信息。

**商户系统和微信支付系统主要交互说明：**

- 步骤1：用户在商户APP中选择商品，提交订单，选择微信支付。
- 步骤2：商户后台收到用户支付单，调用微信支付统一下单接口。参见【统一下单API】。
- 步骤3：统一下单接口返回正常的prepay_id，再按签名规范重新生成签名后，将数据传输给APP。参与签名的字段名为appId，partnerId，prepayId，nonceStr，timeStamp，package。注意：package的值格式为Sign=WXPay
- 步骤4：商户APP调起微信支付。api参见本章节【app端开发步骤说明】
- 步骤5：商户后台接收支付通知。api参见【支付结果通知API】
- 步骤6：商户后台查询支付结果。，api参见【查询订单API】

服务端要做的，就是步骤1235，客户端做步骤4就行了，步骤6看自己的需求，我们没有做。首先，生成商户服务器订单，这个自不必说，
只有生成订单，才有订单号，才能做后面的工作。

我们重点看下步骤2和步骤3

### 调用统一下单接口

首先，我们需要看一下[统一下单接口](https://pay.weixin.qq.com/wiki/doc/api/app.php?chapter=9_1)文档，里面包含了请求的地址和
要传的参数，顾名思义，那些必填字段是必须要填写的，这是我的请求参数列表`out_trade_no`,`body`,`total_fee`,`time_start`,
`time_expire`,`spbill_create_ip`,`notify_url`,`trade_type`还有一个签名`sign`，这就是所有的请求字段。



